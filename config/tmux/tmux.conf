# ~/.config/tmux/tmux.conf: Your open-source terminal multiplexer.
# vim: ft=tmux:

### Settings ###

# Enable mouse mode (tmux 2.1 and above)
set -g mouse on

# Activity bell and whistles
set -g visual-activity on

# Start numbering at 1
set -g base-index 1

# Allows for faster key repetition
set -sg escape-time 50

set -g history-limit 20000
set -g buffer-limit 20
set -g display-time 1500
set -g remain-on-exit off
set -g repeat-time 300
setw -g allow-rename off

set -g focus-events on

# re-number windows when a window is closed
set -g renumber-windows on

# automatically rename to the command running
setw -g automatic-rename on

# Use users default shell
set -g default-shell $SHELL

# Set terminal truecolor
# set -g default-terminal "${TERM}"
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'
setenv -g COLORTERM "truecolor"

# Rather than constraining window size to the maximum size of any client
# connected to the *session*, constrain window size to the maximum size of any
# client connected to *that window*. Much more reasonable.
setw -g aggressive-resize on

### Style ###

# Set parent terminal title to reflect current window in tmux session
set -g set-titles on
set -g set-titles-string "#W:#I"

# border colours
set -g pane-border-style "fg=#2a2a2a"
set -g pane-active-border-style "fg=#2986cc"

# Set window selection highlight style
set -wg mode-style bg=colour24,fg=white

### Status bar ###

# Disable statusline
set -g status off

set -g status-interval 5
set -g status-position bottom
set -g status-justify left
# set -g status-justify centre # center align window list
set -g status-right-length 100
set -g status-left ""
set -g status-right "#[fg=green]#H"

# Set statusbar colors
set -g status-bg black
set -g status-fg white

# Set active tab style
set -wg window-status-current-style fg=magenta

# Set status line message style
set -wg message-style bg=default,fg=colour11
set -wg message-command-style bg=default,fg=colour33

# Prefer vi style key table
setw -g mode-keys vi

### Mappings ###

# Unbind defaults
unbind '"'
unbind %

# remap prefix from 'C-b' to 'C-a'
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# split panes
bind \\ split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# switch panes using Alt-arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# switch panes using hjkl
bind -n M-j select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-h select-pane -D

# new window and retain cwd
bind c new-session -c "#{pane_current_path}"

# Manage tmux configuration
bind M split-window -h "$EDITOR ~/.config/tmux/tmux.conf";
bind r source-file ~/.config/tmux/tmux.conf \; display "TMUX Config reloaded"

# Detach from session
# Prompt for safety, else use upper-case to force
bind D detach
bind d if -F '#{session_many_attached}' \
    'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
    'display "Session has only 1 client attached"'

# Kill pane/window/session shortcuts
bind Q kill-session
bind q confirm-before -p "kill-session '#S'? (y/n)" kill-session

bind X confirm-before -p "kill all windows? (y/n)" "kill-window -a"
bind x confirm-before -p "kill window? (y/n)" kill-window

# Allows us to use C-a a <command> to send commands to a TMUX session inside
# another TMUX session
bind-key a send-prefix

# Toggle status bar
bind S set -g status

# Merge session with another one (e.g. move all windows)
# If you use adhoc 1-window sessions, and you want to preserve session upon exit
# but don't want to create a lot of small unnamed 1-window sessions around
# move all windows from current session to main named one (dev, work, etc)
bind C-u command-prompt -p "Session to merge with: " \
   "run-shell 'yes | head -n #{session_windows} | xargs -I {} -n 1 tmux movew -t %%'"

# External script to quick access sessions via fzf
# bind x run-shell -b "~/.config/tmux/tmux-switch-session.sh"

### Undercurl ###
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0
